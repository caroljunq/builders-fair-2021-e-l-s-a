<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Elsa</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <app-root></app-root>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <div id="chart">
  </div>
  <script>
    function getTemp() {
      return new Promise((resolve, reject) => {
        let xhr = new XMLHttpRequest();

        xhr.open('GET', "https://4p9d4ru3bd.execute-api.us-east-1.amazonaws.com/prod/getTempData");
        xhr.addEventListener('loadend', () => {
          if (xhr.status == 200) {
            resolve(JSON.parse(xhr.responseText)
            );
            const obj = JSON.parse(xhr.responseText)
            resptemp = obj.body
            console.log(resptemp)
          } else {
            console.log(xhr.responseText);
            reject("Não foi possível obter as negociações do servidor.");
          }
        });
        xhr.send();
      })
    }
    function getAlt() {
      return new Promise((resolve, reject) => {
        let xhr = new XMLHttpRequest();

        xhr.open('GET', "https://4p9d4ru3bd.execute-api.us-east-1.amazonaws.com/prod/getAltitude");
        xhr.addEventListener('loadend', () => {
          if (xhr.status == 200) {
            resolve(JSON.parse(xhr.responseText)
            );
            const obj = JSON.parse(xhr.responseText)
            respAlt = obj.body
            console.log(respAlt)
          } else {
            console.log(xhr.responseText);
            reject("Não foi possível obter as negociações do servidor.");
          }
        });
        xhr.send();
      })
    }
    function getLatLong() {
      return new Promise((resolve, reject) => {
        let xhr = new XMLHttpRequest();

        xhr.open('GET', "https://4p9d4ru3bd.execute-api.us-east-1.amazonaws.com/prod/getLatLong");
        xhr.addEventListener('loadend', () => {
          if (xhr.status == 200) {
            resolve(JSON.parse(xhr.responseText)
            );
            const obj = JSON.parse(xhr.responseText)
            resplatlong = obj.body
          } else {
            console.log(xhr.responseText);
            reject("Não foi possível obter as negociações do servidor.");
          }
        });
        xhr.send();
      })
    }
    function plotGraph() {
      var temp = resptemp
      var tempMin = Math.min.apply(null, resptemp) - 3
      var tempMax = Math.max.apply(null, resptemp) + 1
      var options = {
        series: [
          {
            name: "fake_clinic_1",
            data: temp
          },
        ],
        chart: {
          height: 450,
          type: 'line',
          toolbar: {
            show: false
          }
        },
        colors: ['#545454', '#16B3DB', "#8F2F51"],
        dataLabels: {
          enabled: true,
        },
        stroke: {
          curve: 'smooth'
        },
        title: {
          text: 'Temperature',
          align: 'left'
        },
        grid: {
          borderColor: '#e7e7e7',
          row: {
            colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
            opacity: 0.2
          },
        },
        tooltip: {
          custom: function ({ series, seriesIndex, dataPointIndex, w }) {
            var temp = parseFloat(series[seriesIndex][dataPointIndex])
            var tempIdeal = (tempMax+tempMin)/2
            var diffTemp = temp - tempIdeal
            var rottenIndex = (temp * 100 / tempIdeal) - 100
            if (diffTemp == 0) {
              return '<div class="arrow_box">' +
                '<span>' + 'The vaccine is currently under the expected temperature (in Celcius)' + '</span>' +
                '</div>'
            } else if (diffTemp > 0) {
              return '<div class="arrow_box">' +
                '<span>' + 'The vaccine is currently ' + String(diffTemp) + ' Celcius above expected <br> and the rotten index is ' + rottenIndex + '</span>' +
                '</div>'
            } else {
              return '<div class="arrow_box">' +
                '<span>' + 'The vaccine is currently ' + String(diffTemp) + ' Celcius below expected <br> and the rotten index is ' + rottenIndex + '</span>' +
                '</div>'
            }
          }
        },
        markers: {
          size: 1
        },
        xaxis: {
          categories: [],
          title: {
            text: 'Time frame'
          }
        },
        yaxis: {
          title: {
            text: 'Temperature'
          },
          min: tempMin,
          max: tempMax
        },
        annotations: {
          yaxis: [{
            y: tempMin,
            borderColor: '#545454',
            label: {
              borderColor: '#00E396',
              style: {
                color: '#fff',
                background: '#00E396',
              },
              text: 'Support',
            }
          }, {
            y: tempMin,
            y2: tempMin,
            borderColor: '#545454',
            fillColor: '#FFF',
            opacity: 0.2,
            label: {
              borderColor: '#545454',
              style: {
                fontSize: '10px',
                color: '#333',
                background: '#FFF',
              },
              text: 'Min temperature allowed',
            }
          },
            , {
            y: tempMax,
            y2: tempMax,
            borderColor: '#000',
            fillColor: '#FEB019',
            opacity: 0.2,
            label: {
              borderColor: '#333',
              style: {
                fontSize: '10px',
                color: '#fff',
                background: '#8F2F51',
              },
              text: 'max temperature allowed',
            }
          }],
        },
        legend: {
          position: 'top',
          horizontalAlign: 'right',
          floating: true,
          offsetY: -25,
          offsetX: -5
        }
      };

      var chart = new ApexCharts(document.querySelector("#chart"), options);
      chart.render();
    }

    async function f1() {
      await getTemp();
      plotGraph();
      await getLatLong();
      await getAlt();

      if (resptemp[0]> 25 || resptemp[0]< 25 ){
        document.getElementById("colTemp").className = "col alert-danger box";
      }
      if (respAlt[0]> 70){
        document.getElementById("colAlt").className = "col alert-danger box";
      }
      document.getElementById("temp").innerHTML =  String(resptemp[0]);
      document.getElementById("alt").innerHTML =  String(respAlt[0]);
      document.getElementById("location").innerHTML = String(resplatlong[0]) + ", " + String(resplatlong[1]);
    }
    f1()
  </script>

  <app-map></app-map>
  <div class="footer">
    Elsa - Latam Builder's Fair 2021 <br>
    © 2021, Amazon Web Services, Inc. or its Affiliates. All rights reserved. Amazon Confidential and Trademark.
  </div>
</body>

</html>